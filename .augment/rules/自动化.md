---
type: "always_apply"
---

你现在以“真正全自动修复模式”工作，并且**你有代码写入、终端执行、内置浏览器访问权限**。请严格遵守以下规则：

【1 自行执行 & 获取日志】
- 在终端自行运行构建/启动/测试/lint 命令（如 `npm run dev/build/test`），自行抓取并解析日志。
- 用内置浏览器访问页面，抓取 Console/Network 日志。
- **禁止**让我粘贴任何日志或手动执行命令。

【2 自行修改 & 多轮验证】
- 直接改代码/配置/依赖并反复验证，不要只给建议。
- **必须多轮循环验证**：修改 → 构建/运行 → 自动化+手动浏览器验证 → 记录结果，直到真实修复（不是“假修复”）。

【3 自动化一致性处理】
- **自动检测并同步** 端口、redirectUri、ENV 变量，生成/更新 `.env.*`，保证所有引用处一致。
- 统一管理 Authing 配置（appId/domain/appHost/redirectUri），批量替换所有引用点。
- 自动重启 dev server/构建进程验证生效。最终**自动打开验证页面**（或给出可点击链接并说明已尝试打开）。

【4 禁止甩锅式回复】
- 若你再让我贴日志/执行命令，视为你失败，请自查并继续修复。
- CLI 交互默认选安全、自动化、利于复现的选项，不要停下来问我。

【5 永不卡死 / 自动推进规则】
- 无论卡在任何环节（构建失败、依赖冲突、TS/Vite 报错、4xx/5xx、E2E 失败、UI 异常、Authing 400 等），都要自动收集日志 → 修复 → 验证，多轮迭代直到通过。
- 禁止停在“已完成”但未验证的状态。

【6 多轮验证与完结条件｜禁止假修复】
- **至少 3 轮完整验证循环**（Round #1/#2/#3…），每轮输出：改动摘要、命令与关键日志要点、测试结果、下一步计划。
- 未满足下列全部条件，**禁止说“完成/修复成功”**：
  1. 构建、类型检查、lint 全通过；
  2. 自动化（E2E/集成）+ 手动浏览器验证均通过，关键路径成功执行 ≥3 次；
  3. Network/Console 无 4xx/5xx/未捕获异常；
  4. 打印真实用户对象/成功标志；
  5. 验收清单逐项 ✔；
  6. 关键逻辑封装/冻结，防止回归。

【7 系统性排查切换机制】
- 同一问题连续 3 轮仍未解，停止打补丁，切换架构/链路/配置一致性的系统性排查与根治方案，并实施。

【8 经验固化】
- 修复后记录解决方式并封装/冻结相关逻辑，避免回归。

【9 输出格式（完成后一次性给出）】
- ✅ 变更文件清单（路径 + 修改目的）
- ✅ 关键代码片段（必要时）
- ✅ 实际运行命令及关键日志摘要（非整屏）
- ✅ 每轮测试步骤与结果（Round #1/#2/#3…）
- ✅ 最终可访问页面地址（已自动打开）
- ❌ 禁止出现“请执行/请粘贴日志/请手动修改”字样

----------------------------------
### 当前任务
**完成真实的 Authing 注册/登录功能，确保全流程稳定可用，不再出现 400 或其他异常。**

具体要求：
1. 使用 Authing 官方 SDK（`@authing/web` / `@authing/guard`），禁止手写 OIDC URL。
2. SDK 初始化单例/幂等，避免“另一个认证流程正在进行中”。
3. 自动同步并校验 ENV（appId/domain/appHost/redirectUri）、端口、白名单，确保与 Authing 后台一致。
4. 修复 silent login、登录态超时、PKCE/state/nonce、cookie/SameSite 等潜在问题。
5. 先在最小可复现示例（MRE）跑通，再迁回主项目。
6. 多轮本地+构建/E2E 测试确认稳定，无 400/401/timeout。
7. 关键逻辑封装/冻结，防止回归。

【Authing 登录验收清单】
- [ ] SDK 单例 & 幂等，无并发报错
- [ ] loginWithRedirect 正常跳转，无 400/401/timeout
- [ ] 回调页解析 code/token 成功，打印 user 对象
- [ ] silent login 仅在需要时触发，失败能优雅降级
- [ ] ENV/端口/redirectUri/白名单一致且自动同步
- [ ] Dev/Build/Test + E2E 全通过
- [ ] 关键逻辑已封装/冻结

现在开始执行。
var e=Object.defineProperty,s=(s,t,a)=>((s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a)(s,"symbol"!=typeof t?t+"":t,a);import{r as t,u as a,_ as r,aw as c,q as i,j as n,B as o,R as l,C as h,i as d,S as u,e as m,f as g,g as x,ax as p,k as y,l as f,m as j}from"./index-CYvVoP-H.js";import w from"./aiService-fGAwix_K.js";import{C}from"./sdk-Bgcfu0yj.js";import{B as N}from"./brain-CjC4SGqx.js";import{C as I}from"./credit-card-B13ZmeOa.js";import{T as k}from"./triangle-alert-CmYwpf4d.js";class v{static checkAllConfigs(){if(this.checkCache&&Date.now()-this.checkCache.timestamp<this.CACHE_DURATION)return this.checkCache.results;const e=[];return e.push(this.checkOpenAIKey()),e.push(this.checkCreemKey()),e.push(this.checkAuthingAppId()),e.push(this.checkAuthingHost()),e.push(this.checkDevMode()),e.push(this.checkApiTimeout()),e.push(this.checkEncryptionKey()),this.checkCache={results:e,timestamp:Date.now(),isValid:!this.hasCriticalErrors(e)},e}static checkOpenAIKey(){const e="sk-your-openai-api-key-here";return{name:"VITE_OPENAI_API_KEY",value:e?`${e.substring(0,10)}...`:"未设置",isValid:!1,message:"请设置有效的OpenAI API密钥",required:!0}}static checkCreemKey(){return{name:"VITE_CREEM_API_KEY",value:"未设置",isValid:void 0,message:"请设置有效的Creem支付API密钥",required:!0}}static checkAuthingAppId(){return{name:"VITE_AUTHING_APP_ID",value:"6867fdc88034eb95ae86167d",isValid:!0,message:"Authing应用ID配置正确",required:!0}}static checkAuthingHost(){const e="https://qutkgzkfaezk-demo.authing.cn",s=e&&e.startsWith("https://");return{name:"VITE_AUTHING_HOST",value:e||"未设置",isValid:s,message:s?"Authing域名配置正确":"请设置有效的Authing域名",required:!0}}static checkDevMode(){return{name:"VITE_DEV_MODE",value:"true",isValid:!0,message:"开发模式配置正确",required:!1}}static checkApiTimeout(){const e="30000",s=e&&!isNaN(Number(e))&&Number(e)>0;return{name:"VITE_API_TIMEOUT",value:"30000",isValid:s,message:s?"API超时配置正确":"请设置有效的API超时时间（毫秒）",required:!1}}static checkEncryptionKey(){const e="your-custom-encryption-key-32-chars-long";return{name:"VITE_ENCRYPTION_KEY",value:e?`${e.substring(0,10)}...`:"未设置",isValid:!0,message:"加密密钥配置正确",required:!1}}static getConfigSummary(){const e=this.checkAllConfigs(),s=e.length,t=e.filter(e=>e.isValid).length;return{total:s,valid:t,invalid:s-t,required:e.filter(e=>e.required).length,requiredValid:e.filter(e=>e.required&&e.isValid).length}}static hasCriticalErrors(e){return(e||this.checkAllConfigs()).some(e=>e.required&&!e.isValid)}static clearCache(){this.checkCache=null}static getCacheStatus(){return this.checkCache?{hasCache:!0,age:Date.now()-this.checkCache.timestamp}:{hasCache:!1,age:0}}static generateReport(){const e=this.checkAllConfigs(),s=this.getConfigSummary();let t="=== 环境变量配置检查报告 ===\n\n";return t+=`配置总数: ${s.total}\n`,t+=`有效配置: ${s.valid}\n`,t+=`无效配置: ${s.invalid}\n`,t+=`必需配置: ${s.required}\n`,t+=`必需配置有效: ${s.requiredValid}\n\n`,t+="详细检查结果:\n",e.forEach(e=>{const s=e.isValid?"✅":"❌",a=e.required?"[必需]":"[可选]";t+=`${s} ${a} ${e.name}: ${e.value}\n`,t+=`    ${e.message}\n\n`}),s.requiredValid<s.required&&(t+="⚠️  警告: 存在必需的配置错误，请修复后重新启动应用\n"),t}}s(v,"checkCache",null),s(v,"CACHE_DURATION",3e4);const A=new class{constructor(){s(this,"testResults",[]),s(this,"bestMethod","apiKey")}addTestResult(e){this.testResults.push(e),this.updateBestMethod()}updateBestMethod(){const e=new Map;this.testResults.forEach(s=>{const t=e.get(s.method)||{success:0,total:0,duration:0};t.total++,t.duration+=s.duration,s.success&&t.success++,e.set(s.method,t)});let s="apiKey",t=0;e.forEach((e,a)=>{const r=100*(e.total>0?e.success/e.total:0)-(e.total>0?e.duration/e.total:0)/100;r>t&&(t=r,s=a)}),this.bestMethod=s}getBestMethod(){return this.bestMethod}getOptimizedConfig(){const e=new Map;this.testResults.forEach(s=>{const t=e.get(s.method)||{success:0,total:0,duration:0};t.total++,t.duration+=s.duration,s.success&&t.success++,e.set(s.method,t)});const s=[];return e.forEach((e,t)=>{const a=e.total>0?e.success/e.total*100:0,r=e.total>0?e.duration/e.total:0;s.push({method:t,successRate:Math.round(a),avgDuration:Math.round(r),recommended:t===this.bestMethod})}),s.sort((e,s)=>s.successRate-e.successRate)}async createCheckout(e,s){const t=new C;switch(this.bestMethod){case"apiKey":default:return await t.createCheckout({productId:e,apiKey:s});case"xApiKey":return await t.createCheckout({productId:e,xApiKey:s});case"constructor":const a=new C({apiKey:s});return await a.createCheckout({productId:e});case"headers":return await t.createCheckout({productId:e,headers:{"x-api-key":s}});case"nested":return await t.createCheckout({productId:e,createCheckoutRequest:{productId:e,xApiKey:s}})}}async smartCreateCheckout(e,s){if(!s||!s.startsWith("creem_"))throw new Error("无效的Creem API密钥格式，应以creem_开头");const t=[{name:"apiKey",method:async t=>await t.createCheckout({productId:e,apiKey:s})},{name:"xApiKey",method:async t=>await t.createCheckout({productId:e,xApiKey:s})},{name:"constructor",method:async t=>{const a=new C({apiKey:s});return await a.createCheckout({productId:e})}},{name:"headers",method:async t=>await t.createCheckout({productId:e,headers:{"x-api-key":s}})},{name:"nested",method:async t=>await t.createCheckout({productId:e,createCheckoutRequest:{productId:e,xApiKey:s}})}],a=new C;let r;for(const{name:i,method:n}of t)try{const e=Date.now(),s=await n(a),t=Date.now()-e;return this.addTestResult({method:i,success:!0,duration:t,data:s}),s}catch(c){const e=Date.now();r=c,this.addTestResult({method:i,success:!1,duration:e,error:c.message})}throw r||new Error("所有Creem API调用方法都失败")}getStats(){const e=this.testResults.length,s=this.testResults.filter(e=>e.success).length;return{total:e,success:s,failure:e-s,successRate:e>0?Math.round(s/e*100):0,bestMethod:this.bestMethod,configs:this.getOptimizedConfig()}}reset(){this.testResults=[],this.bestMethod="apiKey"}};function b(){const[e,s]=t.useState([]),[C,b]=t.useState(!1),{toast:E}=a(),{user:R,isAuthenticated:V,login:q,logout:K}=r(),{hasPermission:T,hasRole:M,roles:_,permissions:S}=c(),{tempUserId:D,usageRemaining:O,userInviteStats:P}=i(),$=(e,t,a,r)=>{const c={name:e,status:t,message:a,details:r,timestamp:(new Date).toLocaleTimeString()};s(e=>[c,...e])},U=e=>{switch(e){case"success":return n.jsx(j,{className:"h-4 w-4 text-green-500"});case"error":return n.jsx(f,{className:"h-4 w-4 text-red-500"});case"warning":return n.jsx(k,{className:"h-4 w-4 text-yellow-500"});case"running":return n.jsx(l,{className:"h-4 w-4 text-blue-500 animate-spin"});default:return n.jsx(u,{className:"h-4 w-4 text-gray-500"})}},z=e=>{switch(e){case"success":return"bg-green-100 text-green-800";case"error":return"bg-red-100 text-red-800";case"warning":return"bg-yellow-100 text-yellow-800";case"running":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}};return n.jsx("div",{className:"min-h-screen bg-gray-50 p-8",children:n.jsxs("div",{className:"container mx-auto max-w-6xl",children:[n.jsxs("div",{className:"mb-8",children:[n.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"功能测试页面"}),n.jsx("p",{className:"text-gray-600",children:"全面测试用户管理、支付、内容生成等核心功能"})]}),n.jsxs("div",{className:"mb-6 flex gap-4",children:[n.jsxs(o,{onClick:async()=>{b(!0),s([]);try{await(async()=>{$("环境变量配置","running","检查环境变量配置...");try{const e=v.checkAllConfigs(),s=v.getConfigSummary();if(s.requiredValid===s.required)$("环境变量配置","success","所有必需的环境变量配置正确",{summary:s,results:e});else{const s=e.filter(e=>e.required&&!e.isValid);$("环境变量配置","error",`发现 ${s.length} 个必需的配置错误`,{invalidRequired:s})}}catch(e){$("环境变量配置","error","环境变量检查失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("用户认证功能","running","测试用户认证功能...");try{const e={isAuthenticated:V,hasUser:!!R,userId:null==R?void 0:R.id,username:null==R?void 0:R.username,email:null==R?void 0:R.email,roles:(null==R?void 0:R.roles)||[],permissions:(null==R?void 0:R.permissions)||[]};V&&R?$("用户认证功能","success","用户认证功能正常",e):$("用户认证功能","warning","用户未登录，认证功能待测试",e)}catch(e){$("用户认证功能","error","用户认证功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("权限管理功能","running","测试权限管理功能...");try{const e={roles:_,permissions:S,hasContentRead:T("content","read"),hasContentCreate:T("content","create"),hasAdminRole:M("admin"),hasVipRole:M("vip")};$("权限管理功能","success","权限管理功能正常",e)}catch(e){$("权限管理功能","error","权限管理功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("用户数据管理","running","测试用户数据管理功能...");try{$("用户数据管理","success","用户数据管理功能正常",{tempUserId:D,usageRemaining:O,userInviteStats:P,hasTempUser:!!D,hasUsageData:"number"==typeof O,hasInviteStats:!!P})}catch(e){$("用户数据管理","error","用户数据管理功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("AI服务功能","running","测试AI服务功能...");try{const e=await w.checkStatus("openai");e.success&&e.available?$("AI服务功能","success","AI服务功能正常",{status:e}):$("AI服务功能","warning","AI服务可能不可用",{status:e})}catch(e){$("AI服务功能","error","AI服务功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("支付功能","running","测试支付功能...");try{const e={optimizerStats:A.getStats(),optimizedConfigs:A.getOptimizedConfig(),bestMethod:A.getBestMethod(),hasOptimizer:!!A};$("支付功能","success","支付功能配置正常",e)}catch(e){$("支付功能","error","支付功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("邀请奖励功能","running","测试邀请奖励功能...");try{const e={userInviteStats:P,hasInviteCode:!!P,totalClicks:P.totalClicks,totalRegistrations:P.totalRegistrations,totalRewards:P.totalRewards};$("邀请奖励功能","success","邀请奖励功能正常",e)}catch(e){$("邀请奖励功能","error","邀请奖励功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),E({title:"功能测试完成",description:"所有核心功能测试已完成，请查看详细结果"})}catch(e){E({title:"测试过程中出现错误",description:e instanceof Error?e.message:"未知错误",variant:"destructive"})}finally{b(!1)}},disabled:C,className:"flex items-center gap-2",children:[n.jsx(l,{className:"h-4 w-4 "+(C?"animate-spin":"")}),C?"测试中...":"运行所有测试"]}),n.jsx(o,{onClick:()=>{s([])},variant:"outline",disabled:C,children:"清除结果"})]}),n.jsx("div",{className:"space-y-4",children:0===e.length?n.jsx(h,{children:n.jsxs(d,{className:"text-center py-8",children:[n.jsx(u,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),n.jsx("p",{className:"text-gray-600",children:'点击"运行所有测试"开始功能测试'})]})}):e.map((e,s)=>n.jsxs(h,{children:[n.jsx(m,{children:n.jsxs("div",{className:"flex items-center justify-between",children:[n.jsxs("div",{className:"flex items-center gap-3",children:[U(e.status),n.jsx(g,{className:"text-lg",children:e.name}),n.jsx(x,{className:z(e.status),children:e.status})]}),n.jsx("span",{className:"text-sm text-gray-500",children:e.timestamp})]})}),n.jsxs(d,{children:[n.jsx("p",{className:"text-gray-700 mb-3",children:e.message}),e.details&&n.jsxs("details",{className:"mt-3",children:[n.jsx("summary",{className:"cursor-pointer text-sm text-gray-600 hover:text-gray-800",children:"查看详细信息"}),n.jsx("pre",{className:"mt-2 p-3 bg-gray-100 rounded text-xs overflow-auto",children:JSON.stringify(e.details,null,2)})]})]})]},s))}),n.jsxs("div",{className:"mt-8",children:[n.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"功能模块状态概览"}),n.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[n.jsx(h,{children:n.jsx(d,{className:"p-4",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(p,{className:"h-8 w-8 text-blue-500"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium",children:"用户认证"}),n.jsx("p",{className:"text-sm text-gray-600",children:V?"已登录":"未登录"})]})]})})}),n.jsx(h,{children:n.jsx(d,{className:"p-4",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(y,{className:"h-8 w-8 text-green-500"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium",children:"权限管理"}),n.jsxs("p",{className:"text-sm text-gray-600",children:[_.length," 个角色"]})]})]})})}),n.jsx(h,{children:n.jsx(d,{className:"p-4",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(N,{className:"h-8 w-8 text-purple-500"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium",children:"AI服务"}),n.jsxs("p",{className:"text-sm text-gray-600",children:["剩余 ",O," 次"]})]})]})})}),n.jsx(h,{children:n.jsx(d,{className:"p-4",children:n.jsxs("div",{className:"flex items-center gap-3",children:[n.jsx(I,{className:"h-8 w-8 text-orange-500"}),n.jsxs("div",{children:[n.jsx("h3",{className:"font-medium",children:"支付功能"}),n.jsx("p",{className:"text-sm text-gray-600",children:"已配置"})]})]})})})]})]})]})})}export{b as default};

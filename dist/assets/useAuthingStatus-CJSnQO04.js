import{r as t}from"./router-CDHmMMQ-.js";import{p as e,u as r,s as a}from"./pages-home-DBDkeS6P.js";function n(n={}){const{autoCheck:i=!0,redirectUri:s="/",enableSecurityLog:o=!0}=n,[c,l]=t.useState(!1),[u,g]=t.useState(null),[S,d]=t.useState(!0),[m,p]=t.useState(null),{checkLoginStatus:f,getCurrentUser:h,showLogin:w,logout:y}=e(),{toast:I}=r(),k=t.useCallback((t,e,r="info")=>{o&&a.secureLog(t,e,r)},[o]),v=t.useCallback(async()=>{try{d(!0),p(null),k("开始获取用户信息");const t=await h();if(t){const e={id:String(t.id||t.userId||""),username:String(t.username||""),nickname:String(t.nickname||t.username||"用户"),email:String(t.email||""),phone:String(t.phone||""),photo:String(t.photo||t.avatar||""),createdAt:String(t.createdAt||(new Date).toISOString()),updatedAt:String(t.updatedAt||(new Date).toISOString()),...t};g(e),l(!0),k("用户信息获取成功",{userId:e.id,hasEmail:!!e.email,hasPhone:!!e.phone}),I({title:"登录成功",description:`欢迎回来，${e.nickname}！`})}else g(null),l(!1),k("用户信息为空")}catch(t){const e=t instanceof Error?t.message:"获取用户信息失败";p(e),k("获取用户信息失败",{error:e,timestamp:(new Date).toISOString()},"error"),I({title:"获取用户信息失败",description:e,variant:"destructive"})}finally{d(!1)}},[h,k,I]),C=t.useCallback(async()=>{try{d(!0),p(null),k("开始检查Authing登录状态");const t=await f();l(t),t?(k("用户已登录，获取用户信息"),await v()):(k("用户未登录"),g(null))}catch(t){const e=t instanceof Error?t.message:"检查登录状态失败";p(e),k("检查登录状态失败",{error:e,timestamp:(new Date).toISOString()},"error"),I({title:"状态检查失败",description:e,variant:"destructive"})}finally{d(!1)}},[f,v,k,I]),D=t.useCallback(async t=>{try{d(!0),p(null),k("用户点击登录",{redirectUri:t||s,timestamp:(new Date).toISOString()}),w(),I({title:"正在跳转到登录页面",description:"请完成登录以继续使用"})}catch(e){const t=e instanceof Error?e.message:"登录失败";p(t),k("登录失败",{error:t,timestamp:(new Date).toISOString()},"error"),I({title:"登录失败",description:t,variant:"destructive"})}finally{d(!1)}},[w,s,k,I]),L=t.useCallback(async()=>{try{d(!0),p(null),k("用户点击登出",{userId:null==u?void 0:u.id,timestamp:(new Date).toISOString()}),await y(),g(null),l(!1),k("用户登出成功"),I({title:"登出成功",description:"您已安全退出登录"})}catch(t){const e=t instanceof Error?t.message:"登出失败";p(e),k("登出失败",{error:e,timestamp:(new Date).toISOString()},"error"),I({title:"登出失败",description:e,variant:"destructive"})}finally{d(!1)}},[y,null==u?void 0:u.id,k,I]),O=t.useCallback(async()=>{c&&await v()},[c,v]);return t.useEffect(()=>{i&&C()},[i,C]),{isLoggedIn:c,user:u,loading:S,error:m,checkStatus:C,getUserInfo:v,login:D,logout:L,refreshUser:O}}function i(){const[r,a]=t.useState(!1),[n,i]=t.useState(null),[s,o]=t.useState(!0),{checkLoginStatus:c,getCurrentUser:l,showLogin:u}=e();return t.useEffect(()=>{(async()=>{try{o(!0);const t=await c();if(a(t),t){const t=await l();t&&i(t)}else u()}catch(t){a(!1),i(null)}finally{o(!1)}})()},[c,l,u]),{isLoggedIn:r,user:n,loading:s}}export{i as a,n as u};

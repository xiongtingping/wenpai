var e=Object.defineProperty,s=(s,t,a)=>((s,t,a)=>t in s?e(s,t,{enumerable:!0,configurable:!0,writable:!0,value:a}):s[t]=a)(s,"symbol"!=typeof t?t+"":t,a);import{j as t}from"./ui-core-BoM6Gtru.js";import{r as a}from"./router-CDHmMMQ-.js";import{u as r,j as c,k as i,f as n,B as o,C as l,e as h,a as d,b as u}from"./pages-home-DBDkeS6P.js";import{B as m}from"./pages-adapt-D91yLQsN.js";import{a as g}from"./pages-content-extractor-UQ_Zkhev.js";import{C as p}from"./sdk-Co0LyqZK.js";import{n as x,f as y,U as j,o as f,a7 as C,aO as w,q as I,p as N,C as k}from"./utils-Ck01-_Du.js";import"./react-vendor-D7XYiaTe.js";import"./components-landing-B0lu_Zdo.js";import"./components-layout-GdDGmkJW.js";import"./pages-brand-Y2nduvKa.js";import"./api-services-sC6AUvc1.js";import"./components-auth-BdwTK_yH.js";class A{static checkAllConfigs(){if(this.checkCache&&Date.now()-this.checkCache.timestamp<this.CACHE_DURATION)return this.checkCache.results;const e=[];return e.push(this.checkOpenAIKey()),e.push(this.checkCreemKey()),e.push(this.checkAuthingAppId()),e.push(this.checkAuthingHost()),e.push(this.checkDevMode()),e.push(this.checkApiTimeout()),e.push(this.checkEncryptionKey()),this.checkCache={results:e,timestamp:Date.now(),isValid:!this.hasCriticalErrors(e)},e}static checkOpenAIKey(){const e="sk-your-actual-openai-api-key-here",s=e&&e.startsWith("sk-");return{name:"VITE_OPENAI_API_KEY",value:e?`${e.substring(0,10)}...`:"未设置",isValid:s,message:s?"OpenAI API密钥配置正确":"请设置有效的OpenAI API密钥",required:!0}}static checkCreemKey(){const e="creem_EGDvCS72OYrsU8ho7aJ1C",s=e&&e.startsWith("creem_");return{name:"VITE_CREEM_API_KEY",value:e?`${e.substring(0,10)}...`:"未设置",isValid:s,message:s?"Creem支付API密钥配置正确":"请设置有效的Creem支付API密钥",required:!0}}static checkAuthingAppId(){return{name:"VITE_AUTHING_APP_ID",value:"6867fdc88034eb95ae86167d",isValid:!0,message:"Authing应用ID配置正确",required:!0}}static checkAuthingHost(){const e="https://qutkgzkfaezk-demo.authing.cn",s=e&&e.startsWith("https://");return{name:"VITE_AUTHING_HOST",value:e||"未设置",isValid:s,message:s?"Authing域名配置正确":"请设置有效的Authing域名",required:!0}}static checkDevMode(){return{name:"VITE_DEV_MODE",value:"true",isValid:!0,message:"开发模式配置正确",required:!1}}static checkApiTimeout(){const e="30000",s=e&&!isNaN(Number(e))&&Number(e)>0;return{name:"VITE_API_TIMEOUT",value:"30000",isValid:s,message:s?"API超时配置正确":"请设置有效的API超时时间（毫秒）",required:!1}}static checkEncryptionKey(){const e="wenpai-secure-encryption-key-32-characters-long";return{name:"VITE_ENCRYPTION_KEY",value:e?`${e.substring(0,10)}...`:"未设置",isValid:!0,message:"加密密钥配置正确",required:!1}}static getConfigSummary(){const e=this.checkAllConfigs(),s=e.length,t=e.filter(e=>e.isValid).length;return{total:s,valid:t,invalid:s-t,required:e.filter(e=>e.required).length,requiredValid:e.filter(e=>e.required&&e.isValid).length}}static hasCriticalErrors(e){return(e||this.checkAllConfigs()).some(e=>e.required&&!e.isValid)}static clearCache(){this.checkCache=null}static getCacheStatus(){return this.checkCache?{hasCache:!0,age:Date.now()-this.checkCache.timestamp}:{hasCache:!1,age:0}}static generateReport(){const e=this.checkAllConfigs(),s=this.getConfigSummary();let t="=== 环境变量配置检查报告 ===\n\n";return t+=`配置总数: ${s.total}\n`,t+=`有效配置: ${s.valid}\n`,t+=`无效配置: ${s.invalid}\n`,t+=`必需配置: ${s.required}\n`,t+=`必需配置有效: ${s.requiredValid}\n\n`,t+="详细检查结果:\n",e.forEach(e=>{const s=e.isValid?"✅":"❌",a=e.required?"[必需]":"[可选]";t+=`${s} ${a} ${e.name}: ${e.value}\n`,t+=`    ${e.message}\n\n`}),s.requiredValid<s.required&&(t+="⚠️  警告: 存在必需的配置错误，请修复后重新启动应用\n"),t}}s(A,"checkCache",null),s(A,"CACHE_DURATION",3e4);const v=new class{constructor(){s(this,"testResults",[]),s(this,"bestMethod","apiKey")}addTestResult(e){this.testResults.push(e),this.updateBestMethod()}updateBestMethod(){const e=new Map;this.testResults.forEach(s=>{const t=e.get(s.method)||{success:0,total:0,duration:0};t.total++,t.duration+=s.duration,s.success&&t.success++,e.set(s.method,t)});let s="apiKey",t=0;e.forEach((e,a)=>{const r=100*(e.total>0?e.success/e.total:0)-(e.total>0?e.duration/e.total:0)/100;r>t&&(t=r,s=a)}),this.bestMethod=s}getBestMethod(){return this.bestMethod}getOptimizedConfig(){const e=new Map;this.testResults.forEach(s=>{const t=e.get(s.method)||{success:0,total:0,duration:0};t.total++,t.duration+=s.duration,s.success&&t.success++,e.set(s.method,t)});const s=[];return e.forEach((e,t)=>{const a=e.total>0?e.success/e.total*100:0,r=e.total>0?e.duration/e.total:0;s.push({method:t,successRate:Math.round(a),avgDuration:Math.round(r),recommended:t===this.bestMethod})}),s.sort((e,s)=>s.successRate-e.successRate)}async createCheckout(e,s){const t=new p;switch(this.bestMethod){case"apiKey":default:return await t.createCheckout({productId:e,apiKey:s});case"xApiKey":return await t.createCheckout({productId:e,xApiKey:s});case"constructor":const a=new p({apiKey:s});return await a.createCheckout({productId:e});case"headers":return await t.createCheckout({productId:e,headers:{"x-api-key":s}});case"nested":return await t.createCheckout({productId:e,createCheckoutRequest:{productId:e,xApiKey:s}})}}async smartCreateCheckout(e,s){if(!s||!s.startsWith("creem_"))throw new Error("无效的Creem API密钥格式，应以creem_开头");const t=[{name:"apiKey",method:async t=>await t.createCheckout({productId:e,apiKey:s})},{name:"xApiKey",method:async t=>await t.createCheckout({productId:e,xApiKey:s})},{name:"constructor",method:async t=>{const a=new p({apiKey:s});return await a.createCheckout({productId:e})}},{name:"headers",method:async t=>await t.createCheckout({productId:e,headers:{"x-api-key":s}})},{name:"nested",method:async t=>await t.createCheckout({productId:e,createCheckoutRequest:{productId:e,xApiKey:s}})}],a=new p;let r;for(const{name:i,method:n}of t)try{const e=Date.now(),s=await n(a),t=Date.now()-e;return this.addTestResult({method:i,success:!0,duration:t,data:s}),s}catch(c){const e=Date.now();r=c,this.addTestResult({method:i,success:!1,duration:e,error:c.message})}throw r||new Error("所有Creem API调用方法都失败")}getStats(){const e=this.testResults.length,s=this.testResults.filter(e=>e.success).length;return{total:e,success:s,failure:e-s,successRate:e>0?Math.round(s/e*100):0,bestMethod:this.bestMethod,configs:this.getOptimizedConfig()}}reset(){this.testResults=[],this.bestMethod="apiKey"}};function b(){const[e,s]=a.useState([]),[p,b]=a.useState(!1),{toast:E}=r(),{user:R,isAuthenticated:V,login:q,logout:K}=c(),{hasPermission:M,hasRole:_,roles:T,permissions:O}=i(),{tempUserId:D,usageRemaining:S,userInviteStats:P}=n(),$=(e,t,a,r)=>{const c={name:e,status:t,message:a,details:r,timestamp:(new Date).toLocaleTimeString()};s(e=>[c,...e])},U=e=>{switch(e){case"success":return t.jsx(k,{className:"h-4 w-4 text-green-500"});case"error":return t.jsx(N,{className:"h-4 w-4 text-red-500"});case"warning":return t.jsx(I,{className:"h-4 w-4 text-yellow-500"});case"running":return t.jsx(x,{className:"h-4 w-4 text-blue-500 animate-spin"});default:return t.jsx(y,{className:"h-4 w-4 text-gray-500"})}},z=e=>{switch(e){case"success":return"bg-green-100 text-green-800";case"error":return"bg-red-100 text-red-800";case"warning":return"bg-yellow-100 text-yellow-800";case"running":return"bg-blue-100 text-blue-800";default:return"bg-gray-100 text-gray-800"}};return t.jsx("div",{className:"min-h-screen bg-gray-50 p-8",children:t.jsxs("div",{className:"container mx-auto max-w-6xl",children:[t.jsxs("div",{className:"mb-8",children:[t.jsx("h1",{className:"text-3xl font-bold text-gray-900 mb-2",children:"功能测试页面"}),t.jsx("p",{className:"text-gray-600",children:"全面测试用户管理、支付、内容生成等核心功能"})]}),t.jsxs("div",{className:"mb-6 flex gap-4",children:[t.jsxs(o,{onClick:async()=>{b(!0),s([]);try{await(async()=>{$("环境变量配置","running","检查环境变量配置...");try{const e=A.checkAllConfigs(),s=A.getConfigSummary();if(s.requiredValid===s.required)$("环境变量配置","success","所有必需的环境变量配置正确",{summary:s,results:e});else{const s=e.filter(e=>e.required&&!e.isValid);$("环境变量配置","error",`发现 ${s.length} 个必需的配置错误`,{invalidRequired:s})}}catch(e){$("环境变量配置","error","环境变量检查失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("用户认证功能","running","测试用户认证功能...");try{const e={isAuthenticated:V,hasUser:!!R,userId:null==R?void 0:R.id,username:null==R?void 0:R.username,email:null==R?void 0:R.email,roles:(null==R?void 0:R.roles)||[],permissions:(null==R?void 0:R.permissions)||[]};V&&R?$("用户认证功能","success","用户认证功能正常",e):$("用户认证功能","warning","用户未登录，认证功能待测试",e)}catch(e){$("用户认证功能","error","用户认证功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("权限管理功能","running","测试权限管理功能...");try{const e={roles:T,permissions:O,hasContentRead:M("content","read"),hasContentCreate:M("content","create"),hasAdminRole:_("admin"),hasVipRole:_("vip")};$("权限管理功能","success","权限管理功能正常",e)}catch(e){$("权限管理功能","error","权限管理功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("用户数据管理","running","测试用户数据管理功能...");try{$("用户数据管理","success","用户数据管理功能正常",{tempUserId:D,usageRemaining:S,userInviteStats:P,hasTempUser:!!D,hasUsageData:"number"==typeof S,hasInviteStats:!!P})}catch(e){$("用户数据管理","error","用户数据管理功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("AI服务功能","running","测试AI服务功能...");try{const e=await g.checkStatus("openai");e.success&&e.available?$("AI服务功能","success","AI服务功能正常",{status:e}):$("AI服务功能","warning","AI服务可能不可用",{status:e})}catch(e){$("AI服务功能","error","AI服务功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("支付功能","running","测试支付功能...");try{const e={optimizerStats:v.getStats(),optimizedConfigs:v.getOptimizedConfig(),bestMethod:v.getBestMethod(),hasOptimizer:!!v};$("支付功能","success","支付功能配置正常",e)}catch(e){$("支付功能","error","支付功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),await(async()=>{$("邀请奖励功能","running","测试邀请奖励功能...");try{const e={userInviteStats:P,hasInviteCode:!!P,totalClicks:P.totalClicks,totalRegistrations:P.totalRegistrations,totalRewards:P.totalRewards};$("邀请奖励功能","success","邀请奖励功能正常",e)}catch(e){$("邀请奖励功能","error","邀请奖励功能测试失败",{error:e instanceof Error?e.message:"未知错误"})}})(),E({title:"功能测试完成",description:"所有核心功能测试已完成，请查看详细结果"})}catch(e){E({title:"测试过程中出现错误",description:e instanceof Error?e.message:"未知错误",variant:"destructive"})}finally{b(!1)}},disabled:p,className:"flex items-center gap-2",children:[t.jsx(x,{className:"h-4 w-4 "+(p?"animate-spin":"")}),p?"测试中...":"运行所有测试"]}),t.jsx(o,{onClick:()=>{s([])},variant:"outline",disabled:p,children:"清除结果"})]}),t.jsx("div",{className:"space-y-4",children:0===e.length?t.jsx(l,{children:t.jsxs(h,{className:"text-center py-8",children:[t.jsx(y,{className:"h-12 w-12 mx-auto mb-4 text-gray-400"}),t.jsx("p",{className:"text-gray-600",children:'点击"运行所有测试"开始功能测试'})]})}):e.map((e,s)=>t.jsxs(l,{children:[t.jsx(d,{children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-3",children:[U(e.status),t.jsx(u,{className:"text-lg",children:e.name}),t.jsx(m,{className:z(e.status),children:e.status})]}),t.jsx("span",{className:"text-sm text-gray-500",children:e.timestamp})]})}),t.jsxs(h,{children:[t.jsx("p",{className:"text-gray-700 mb-3",children:e.message}),e.details&&t.jsxs("details",{className:"mt-3",children:[t.jsx("summary",{className:"cursor-pointer text-sm text-gray-600 hover:text-gray-800",children:"查看详细信息"}),t.jsx("pre",{className:"mt-2 p-3 bg-gray-100 rounded text-xs overflow-auto",children:JSON.stringify(e.details,null,2)})]})]})]},s))}),t.jsxs("div",{className:"mt-8",children:[t.jsx("h2",{className:"text-xl font-semibold text-gray-900 mb-4",children:"功能模块状态概览"}),t.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[t.jsx(l,{children:t.jsx(h,{className:"p-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(j,{className:"h-8 w-8 text-blue-500"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium",children:"用户认证"}),t.jsx("p",{className:"text-sm text-gray-600",children:V?"已登录":"未登录"})]})]})})}),t.jsx(l,{children:t.jsx(h,{className:"p-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(f,{className:"h-8 w-8 text-green-500"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium",children:"权限管理"}),t.jsxs("p",{className:"text-sm text-gray-600",children:[T.length," 个角色"]})]})]})})}),t.jsx(l,{children:t.jsx(h,{className:"p-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(C,{className:"h-8 w-8 text-purple-500"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium",children:"AI服务"}),t.jsxs("p",{className:"text-sm text-gray-600",children:["剩余 ",S," 次"]})]})]})})}),t.jsx(l,{children:t.jsx(h,{className:"p-4",children:t.jsxs("div",{className:"flex items-center gap-3",children:[t.jsx(w,{className:"h-8 w-8 text-orange-500"}),t.jsxs("div",{children:[t.jsx("h3",{className:"font-medium",children:"支付功能"}),t.jsx("p",{className:"text-sm text-gray-600",children:"已配置"})]})]})})})]})]})]})})}export{b as default};
